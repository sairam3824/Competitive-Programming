# Competitive Programming setup

# Clean up old function definitions (if they exist)
unfunction A.cc B.cc C.cc D.cc E.cc F.cc 2>/dev/null

# Get the directory where this script is located
CP_DIR="$( cd "$( dirname "${(%):-%x}" )" && pwd )"

# Function to create a file from template
function cf() {
    if [ -z "$1" ]; then
        echo "Usage: cf <filename>"
        echo "Examples:"
        echo "  cf A.cc      -> creates cpp/A.cc"
        echo "  cf 342.java  -> creates java/342.java"
        echo "  cf app.py    -> creates py/app.py"
        return 1
    fi
    
    FILENAME="$1"
    
    # Determine folder based on extension
    if [[ "$FILENAME" =~ \.cc$ ]] || [[ "$FILENAME" =~ \.cpp$ ]]; then
        FOLDER="codes/cpp/src"
        TEMPLATE="$CP_DIR/templates/template.cc"
    elif [[ "$FILENAME" =~ \.java$ ]]; then
        FOLDER="codes/java"
        TEMPLATE="$CP_DIR/templates/template.java"
    elif [[ "$FILENAME" =~ \.py$ ]]; then
        FOLDER="codes/py"
        TEMPLATE="$CP_DIR/templates/template.py"
    else
        echo "Unsupported file extension. Use .cc, .cpp, .java, or .py"
        return 1
    fi
    
    TARGET="$CP_DIR/$FOLDER/$FILENAME"
    
    if [ -f "$TARGET" ]; then
        echo "File $TARGET already exists!"
        return 1
    fi
    
    # Create from template if available, otherwise create empty file
    if [ -n "$TEMPLATE" ] && [ -f "$TEMPLATE" ]; then
        BASENAME="${FILENAME%.*}"
        sed "s/PROBLEM_NAME/$BASENAME/g" "$TEMPLATE" > "$TARGET"
    else
        touch "$TARGET"
    fi
    
    echo "Created $FOLDER/$FILENAME"
}

# Function to compile and run
function cfrun() {
    if [ -z "$1" ]; then
        echo "Usage: cfrun <filename>"
        echo "Examples:"
        echo "  cfrun A.cc      -> compiles and runs cpp/A.cc"
        echo "  cfrun 342.java  -> compiles and runs java/342.java"
        echo "  cfrun app.py    -> runs py/app.py"
        return 1
    fi
    
    FILENAME="$1"
    
    # Determine folder and compilation based on extension
    if [[ "$FILENAME" =~ \.cc$ ]] || [[ "$FILENAME" =~ \.cpp$ ]]; then
        SRC_FOLDER="codes/cpp/src"
        TEST_FOLDER="codes/cpp"
        FILEPATH="$CP_DIR/$SRC_FOLDER/$FILENAME"
        
        if [ ! -f "$FILEPATH" ]; then
            echo "File $FILEPATH does not exist!"
            return 1
        fi
        
        BASENAME="${FILENAME%.*}"
        OUTFILE="$CP_DIR/$TEST_FOLDER/$BASENAME"
        
        echo "Compiling $SRC_FOLDER/$FILENAME..."
        cd "$CP_DIR/$SRC_FOLDER"
        g++ -std=c++17 -O2 -Wall -Wextra -DDEBUG "$FILENAME" -o "$OUTFILE"
        
        if [ $? -ne 0 ]; then
            echo "Compilation failed!"
            return 1
        fi
        
        echo "Running $BASENAME..."
        echo "-------------------"
        
        cd "$CP_DIR/$TEST_FOLDER"
        
        EXPECTED_FILE="$CP_DIR/$TEST_FOLDER/${BASENAME}-1.out"
        INPUT_FILE="$CP_DIR/$TEST_FOLDER/${BASENAME}-1.in"
        if [ -f "$EXPECTED_FILE" ]; then
            echo "Expected Output:"
            cat "$EXPECTED_FILE"
            echo "-------------------"
            echo "Your Output:"
            
            if [ -f "$INPUT_FILE" ]; then
                ./"$BASENAME" < "$INPUT_FILE" | tee .temp_out
            else
                ./"$BASENAME" | tee .temp_out
            fi
            
            python3 -c "
import sys
try:
    with open(sys.argv[1]) as f1, open(sys.argv[2]) as f2:
        e = [l.strip() for l in f1 if l.strip()]
        o = [l.strip() for l in f2 if l.strip()]
    p = sum(1 for a,b in zip(e,o) if a==b)
    print(f'-------------------\nTest Cases Passed: {p} / {len(e)}')
except: pass" "$EXPECTED_FILE" .temp_out
            rm .temp_out
        else
            if [ -f "$INPUT_FILE" ]; then
                ./"$BASENAME" < "$INPUT_FILE"
            else
                ./"$BASENAME"
            fi
        fi
        
    elif [[ "$FILENAME" =~ \.java$ ]]; then
        FOLDER="codes/java"
        FILEPATH="$CP_DIR/$FOLDER/$FILENAME"
        
        if [ ! -f "$FILEPATH" ]; then
            echo "File $FILEPATH does not exist!"
            return 1
        fi
        
        CLASSNAME="${FILENAME%.java}"
        
        echo "Compiling $FOLDER/$FILENAME..."
        cd "$CP_DIR/$FOLDER"
        javac "$FILENAME"
        
        if [ $? -ne 0 ]; then
            echo "Compilation failed!"
            return 1
        fi
        
        echo "Running $CLASSNAME..."
        echo "-------------------"
        
        EXPECTED_FILE="$CP_DIR/$FOLDER/${CLASSNAME}-1.out"
        INPUT_FILE="$CP_DIR/$FOLDER/${CLASSNAME}-1.in"
        if [ -f "$EXPECTED_FILE" ]; then
            echo "Expected Output:"
            cat "$EXPECTED_FILE"
            echo "-------------------"
            echo "Your Output:"
            
            if [ -f "$INPUT_FILE" ]; then
                java "$CLASSNAME" < "$INPUT_FILE" | tee .temp_out
            else
                java "$CLASSNAME" | tee .temp_out
            fi
            
            python3 -c "
import sys
try:
    with open(sys.argv[1]) as f1, open(sys.argv[2]) as f2:
        e = [l.strip() for l in f1 if l.strip()]
        o = [l.strip() for l in f2 if l.strip()]
    p = sum(1 for a,b in zip(e,o) if a==b)
    print(f'-------------------\nTest Cases Passed: {p} / {len(e)}')
except: pass" "$EXPECTED_FILE" .temp_out
            rm .temp_out
        else
            if [ -f "$INPUT_FILE" ]; then
                java "$CLASSNAME" < "$INPUT_FILE"
            else
                java "$CLASSNAME"
            fi
        fi
        
    elif [[ "$FILENAME" =~ \.py$ ]]; then
        FOLDER="codes/py"
        FILEPATH="$CP_DIR/$FOLDER/$FILENAME"
        
        if [ ! -f "$FILEPATH" ]; then
            echo "File $FILEPATH does not exist!"
            return 1
        fi
        
        echo "Running $FOLDER/$FILENAME..."
        echo "-------------------"
        
        BASENAME="${FILENAME%.py}"
        EXPECTED_FILE="$CP_DIR/$FOLDER/${BASENAME}-1.out"
        INPUT_FILE="$CP_DIR/$FOLDER/${BASENAME}-1.in"
        
        if [ -f "$EXPECTED_FILE" ]; then
            echo "Expected Output:"
            cat "$EXPECTED_FILE"
            echo "-------------------"
            echo "Your Output:"
            
            cd "$CP_DIR/$FOLDER"
            if [ -f "$INPUT_FILE" ]; then
                python3 "$FILENAME" < "$INPUT_FILE" | tee .temp_out
            else
                python3 "$FILENAME" | tee .temp_out
            fi
            
            python3 -c "
import sys
try:
    with open(sys.argv[1]) as f1, open(sys.argv[2]) as f2:
        e = [l.strip() for l in f1 if l.strip()]
        o = [l.strip() for l in f2 if l.strip()]
    p = sum(1 for a,b in zip(e,o) if a==b)
    print(f'-------------------\nTest Cases Passed: {p} / {len(e)}')
except: pass" "$EXPECTED_FILE" .temp_out
            rm .temp_out
        else
            cd "$CP_DIR/$FOLDER"
            if [ -f "$INPUT_FILE" ]; then
                python3 "$FILENAME" < "$INPUT_FILE"
            else
                python3 "$FILENAME"
            fi
        fi
        
    else
        echo "Unsupported file extension. Use .cc, .cpp, .java, or .py"
        return 1
    fi
}

# Alias for convenience
alias run='cfrun'

# Start Competitive Companion listener
function cflisten() {
    echo "Starting Competitive Companion listener..."
    cd "$CP_DIR"
    node listener.js
}
